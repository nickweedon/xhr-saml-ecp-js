<html>
<head>
    <script type="text/javascript" src="../bower_components/requirejs/require.js"></script>
    <script type="text/javascript" src="js/require-deps.js"></script>
    <link rel="stylesheet" href="css/colorbox.css">    
</head>
<body>
<H1>SAML Authentication Test</H1>

<input type="button" name="login" value="Login" onclick="doLogin()">

<div id="output"></div>

<script type="text/javascript">

    var storedUsername = null;

	require(["xhr-saml-ecp-js", "xhr-adaptor-js", "jquery", "jquery-colorbox"], function(xhrSamlEcpJs, xhrAdaptorJs) {

        console.debug("Setting up saml");
		xhrSamlEcpJs.SamlEcpClientXHR.config({
			options: {
				idpEndpointUrl: "http://wyvern.weedon.int:8030/idp/profile/SAML2/SOAP/ECP"
			},
			aclList: [{
				urlPattern: "^http://saml-sp.weedon.int",
				options: {
					samlTimeout: 0,
					resourceTimeout: 0,
					onEcpError : function(ecpErrorObj) {

						console.debug("Got error");
						//if(ecpErrorObj.errorCode == samlEcpClientJs.ECP_ERROR.IDP_RESPONSE_ERROR)
                        //TODO: Use an enumeration here
                        if(ecpErrorObj.errorCode === -1)
							console.debug("IdP Error:", ecpErrorObj.idpStatus);
					},
					onError : function(xmlHttp, msg) {
						console.error(msg);
					},
					onEcpAuth : function(authCtx) {
                        console.debug("Entered callback...");

                        if(authCtx.getUsername() === null) {
                            if(storedUsername !== null) {
                                authCtx.setUsername(storedUsername);
                                authCtx.retryAuth();
                                return;
                            }
                        }

						$.colorbox({
							html: "\
			                    <table>\
			                    <tr><td>Username: </td><td><input id='username'></td></tr>\
			                    <tr><td>Password: </td><td><input id='password' type='password'></td></tr>\
			                    </table>\
			                    <input type='button' name='continue' value='continue' onclick='$.colorbox.close()'>\
			                ",
							onCleanup : function() {

                                console.debug("Calling cleanup...");

                                var password = $("#password").val();
                                storedUsername = $("#username").val();

                                setTimeout(function() {
                                    console.debug("Continuing saml auth...");

                                    authCtx.setUsername(storedUsername);
                                    authCtx.setPassword(password);
                                    console.debug("Retrying with username/password '" + storedUsername + "'/'" + password + "'...");
                                    authCtx.retryAuth();
                                }, 500);
							},
                            onComplete : function() {
                                if(storedUsername !== null) {
                                    $("#username").val(storedUsername);
                                }
                            }
						});
                        console.debug("Exited callback...")
					}
				}
			}]
        });

        console.debug("Setting up saml");

		xhrAdaptorJs.manager.injectWrapper(xhrSamlEcpJs.SamlEcpClientXHR);
	});

	function doLogin() {

		require(["jquery"], function() {

			// Not that this URL MUST match exactly the url in the metadata or else
			// the correct cookie will not be used during the first half of authentication
			//var url = "http://media-center.weedon.int:8080/spring-security-saml2-sample/";
			var url = "http://saml-sp.weedon.int/";

            $.ajax({
                type: 'GET',
                url: url,
                contentType: 'text/html',
                xhrFields: {
                    withCredentials: true
                },
                success: function(data) {
                    $("#output").html(data);
                },
                error: function() {
                    console.error("Error occurred in ajax resource request");
                }
            });
		});
	}
	
	function continueLogin() {
		
	}
</script>

    
</body>
</html>